---
# tasks file for openssh

- name: SmokeTests
  ansible.builtin.debug:
    msg:
      - "ansible_version => {{ ansible_version }}"
      - "ansible_distribution => {{ ansible_distribution }}"
      - "ansible_distribution_release => {{ ansible_distribution_release }}"
      - "ansible_distribution_major_version => {{ ansible_distribution_major_version }}"
      - "ansible_os_family  => {{ ansible_os_family }}"
      - "ansible_system  => {{ ansible_system }}"

# - name: Fail play here
#   ansible.builtin.fail:

- name: Import assert.yml
  ansible.builtin.import_tasks: assert.yml
  run_once: yes
  delegate_to: localhost

- name: Install openssh
  ansible.builtin.package:
    name: "{{ openssh_packages }}"
    state: present

- name: Configure selinux to allow openssh_port
  community.general.seport:
    ports: "{{ openssh_port }}"
    proto: "tcp"
    setype: "ssh_port_t"
    state: "present"
  when:
    - ansible_selinux.status is defined
    - ansible_selinux.status == "enabled"

- name: Generate host key
  ansible.builtin.command:
    cmd: "/usr/bin/ssh-keygen -q -t {{ item }} -f /etc/ssh/ssh_host_{{ item }}_key -C '' -N ''"
    creates: "/etc/ssh/ssh_host_{{ item }}_key"
  loop: "{{ openssh_key_types }}"

- name: Make run directory
  ansible.builtin.file:
    path: "{{ openssh_run_directory }}"
    state: directory
    mode: "0755"
  when:
    - ansible_os_family == "Debian"

- name: Configure openssh
  ansible.builtin.template:
    dest: "{{ openssh_configuration_file }}"
    src: "{{ openssh_template_src }}"
    mode: "{{ openssh_template_mode }}"
    owner: root
    group: root
    validate: sshd -f %s -t
  notify:
    - Restart openssh

- name: Start and enable openssh
  ansible.builtin.service:
    name: "{{ openssh_service }}"
    state: started
    enabled: yes

- name: Flush handlers
  ansible.builtin.meta: flush_handlers
